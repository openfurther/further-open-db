/* Create Missing PKs */
ALTER TABLE CONDITION_ERA 
  ADD CONSTRAINT CONDITION_ERA_PK
  PRIMARY KEY (CONDITION_ERA_ID);

ALTER TABLE CONDITION_OCCURRENCE_REF
  ADD CONSTRAINT CONDITION_OCCURRENCE_REF_PK
  PRIMARY KEY (CONDITION_OCCURRENCE_TYPE);

/* Skip this one since it is already there in the original DDL */
/*
ALTER TABLE CONDITION_OCCURRENCE 
  ADD CONSTRAINT CONDITION_OCCURRENCE_PK
  PRIMARY KEY (CONDITION_OCCURRENCE_ID);
*/

ALTER TABLE DRUG_ERA 
  ADD CONSTRAINT DRUG_ERA_PK
  PRIMARY KEY (DRUG_ERA_ID);

ALTER TABLE DRUG_EXPOSURE 
  ADD CONSTRAINT DRUG_EXPOSURE_PK
  PRIMARY KEY (DRUG_EXPOSURE_ID);

ALTER TABLE DRUG_EXPOSURE_REF
  ADD CONSTRAINT DRUG_EXPOSURE_REF_PK
  PRIMARY KEY (DRUG_EXPOSURE_TYPE);

ALTER TABLE OBSERVATION 
  ADD CONSTRAINT OBSERVATION_PK
  PRIMARY KEY (OBS_OCCURRENCE_ID);

ALTER TABLE OBSERVATION_TYPE_REF
  ADD CONSTRAINT OBSERVATION_TYPE_REF_PK
  PRIMARY KEY (OBSERVATION_TYPE);

ALTER TABLE OBSERVATION_PERIOD 
  ADD CONSTRAINT OBSERVATION_PERIOD_PK
  PRIMARY KEY (OBSERVATION_PERIOD_ID);

ALTER TABLE PERSON 
  ADD CONSTRAINT PERSON_PK
  PRIMARY KEY (PERSON_ID);

ALTER TABLE PROCEDURE_OCCURRENCE 
  ADD CONSTRAINT PROCEDURE_OCCURRENCE_PK
  PRIMARY KEY (PROCEDURE_OCCURRENCE_ID);

ALTER TABLE PROC_OCCURRENCE_REF
  ADD CONSTRAINT PROC_OCCURRENCE_REF_PK
  PRIMARY KEY (PROCEDURE_OCCURRENCE_TYPE);

ALTER TABLE VISIT_OCCURRENCE 
  ADD CONSTRAINT VISIT_OCCURRENCE_PK
  PRIMARY KEY (VISIT_OCCURRENCE_ID);

/* End of PKs */


/* BEGIN FKs AFTER PK & Tables */

ALTER TABLE CONDITION_ERA 
  ADD CONSTRAINT CONDITION_ERA_FK1
  FOREIGN KEY (PERSON_ID) 
  REFERENCES PERSON (PERSON_ID);

/* ONLY IF WE HAVE THIS LOOKUP DATA */
ALTER TABLE CONDITION_ERA 
  ADD CONSTRAINT CONDITION_ERA_FK2
  FOREIGN KEY (CONDITION_OCCURRENCE_TYPE) 
  REFERENCES CONDITION_OCCURRENCE_REF (CONDITION_OCCURRENCE_TYPE);


ALTER TABLE CONDITION_OCCURRENCE 
  ADD CONSTRAINT CONDITION_OCCURRENCE_FK1 
  FOREIGN KEY (PERSON_ID) 
  REFERENCES PERSON (PERSON_ID);

/* ONLY IF WE HAVE THIS LOOKUP DATA */
ALTER TABLE CONDITION_OCCURRENCE
  ADD CONSTRAINT CONDITION_OCCURRENCE_FK2
  FOREIGN KEY (CONDITION_OCCURRENCE_TYPE) 
  REFERENCES CONDITION_OCCURRENCE_REF (CONDITION_OCCURRENCE_TYPE);


ALTER TABLE DRUG_ERA 
  ADD CONSTRAINT DRUG_ERA_FK1 
  FOREIGN KEY (PERSON_ID) 
  REFERENCES PERSON (PERSON_ID);

/* ONLY IF WE HAVE THIS LOOKUP DATA */
ALTER TABLE DRUG_ERA 
  ADD CONSTRAINT DRUG_ERA_FK2 
  FOREIGN KEY (DRUG_EXPOSURE_TYPE) 
  REFERENCES DRUG_EXPOSURE_REF (DRUG_EXPOSURE_TYPE);


ALTER TABLE DRUG_EXPOSURE 
  ADD CONSTRAINT DRUG_EXPOSURE_FK1
  FOREIGN KEY (PERSON_ID)  
  REFERENCES PERSON (PERSON_ID);

/* ONLY IF WE HAVE THIS LOOKUP DATA */
ALTER TABLE DRUG_EXPOSURE 
  ADD CONSTRAINT DRUG_EXPOSURE_FK2
  FOREIGN KEY (DRUG_EXPOSURE_TYPE) 
  REFERENCES DRUG_EXPOSURE_REF (DRUG_EXPOSURE_TYPE);


ALTER TABLE OBSERVATION 
  ADD CONSTRAINT OBSERVATION_FK1 
  FOREIGN KEY (PERSON_ID)
  REFERENCES PERSON (PERSON_ID);

/* ONLY IF WE HAVE THIS LOOKUP DATA */
ALTER TABLE OBSERVATION 
  ADD CONSTRAINT OBSERVATION_FK2 
  FOREIGN KEY (OBS_TYPE) 
  REFERENCES OBSERVATION_TYPE_REF (OBSERVATION_TYPE);


ALTER TABLE OBSERVATION_PERIOD 
  ADD CONSTRAINT OBSERVATION_PERIOD_FK1 
  FOREIGN KEY (PERSON_ID)   
  REFERENCES PERSON (PERSON_ID);

ALTER TABLE PROCEDURE_OCCURRENCE 
  ADD CONSTRAINT PROCEDURE_OCCURRENCE_FK1 
  FOREIGN KEY (PERSON_ID)
  REFERENCES PERSON (PERSON_ID);

/* ONLY IF WE HAVE THIS LOOKUP DATA */
ALTER TABLE PROCEDURE_OCCURRENCE 
  ADD CONSTRAINT PROCEDURE_OCCURRENCE_FK2 
  FOREIGN KEY (PROCEDURE_OCCURRENCE_TYPE) 
  REFERENCES PROC_OCCURRENCE_REF (PROCEDURE_OCCURRENCE_TYPE);


ALTER TABLE VISIT_OCCURRENCE 
  ADD CONSTRAINT VISIT_OCCURRENCE_FK1
  FOREIGN KEY (PERSON_ID)   REFERENCES PERSON (PERSON_ID);

/* END FKs */


/* DROP FKs */
/*
ALTER TABLE OMOPV2.CONDITION_ERA DROP CONSTRAINT CONDITION_ERA_FK1;
ALTER TABLE OMOPV2.CONDITION_ERA DROP CONSTRAINT CONDITION_ERA_FK2;
ALTER TABLE OMOPV2.CONDITION_OCCURRENCE DROP CONSTRAINT CONDITION_OCCURRENCE_FK1;
ALTER TABLE OMOPV2.CONDITION_OCCURRENCE DROP CONSTRAINT CONDITION_OCCURRENCE_FK2;
ALTER TABLE OMOPV2.DRUG_ERA DROP CONSTRAINT DRUG_ERA_FK1;
ALTER TABLE OMOPV2.DRUG_ERA DROP CONSTRAINT DRUG_ERA_FK2;
ALTER TABLE OMOPV2.DRUG_EXPOSURE DROP CONSTRAINT DRUG_EXPOSURE_FK1;
ALTER TABLE OMOPV2.DRUG_EXPOSURE DROP CONSTRAINT DRUG_EXPOSURE_FK2;
ALTER TABLE OMOPV2.OBSERVATION DROP CONSTRAINT OBSERVATION_FK1;
ALTER TABLE OMOPV2.OBSERVATION DROP CONSTRAINT OBSERVATION_FK2;
ALTER TABLE OMOPV2.OBSERVATION_PERIOD DROP CONSTRAINT OBSERVATION_PERIOD_FK1;
ALTER TABLE OMOPV2.PROCEDURE_OCCURRENCE DROP CONSTRAINT PROCEDURE_OCCURRENCE_FK1;
ALTER TABLE OMOPV2.PROCEDURE_OCCURRENCE DROP CONSTRAINT PROCEDURE_OCCURRENCE_FK2;
ALTER TABLE OMOPV2.VISIT_OCCURRENCE DROP CONSTRAINT VISIT_OCCURRENCE_FK1;
*/
/* DISABLE FKs Before ETL */
/*
ALTER TABLE OMOPV2.CONDITION_ERA DISABLE CONSTRAINT CONDITION_ERA_FK1;
ALTER TABLE OMOPV2.CONDITION_ERA DISABLE CONSTRAINT CONDITION_ERA_FK2;
ALTER TABLE OMOPV2.CONDITION_OCCURRENCE DISABLE CONSTRAINT CONDITION_OCCURRENCE_FK1;
ALTER TABLE OMOPV2.CONDITION_OCCURRENCE DISABLE CONSTRAINT CONDITION_OCCURRENCE_FK2;
ALTER TABLE OMOPV2.DRUG_ERA DISABLE CONSTRAINT DRUG_ERA_FK1;
ALTER TABLE OMOPV2.DRUG_ERA DISABLE CONSTRAINT DRUG_ERA_FK2;
ALTER TABLE OMOPV2.DRUG_EXPOSURE DISABLE CONSTRAINT DRUG_EXPOSURE_FK1;
ALTER TABLE OMOPV2.DRUG_EXPOSURE DISABLE CONSTRAINT DRUG_EXPOSURE_FK2;
ALTER TABLE OMOPV2.OBSERVATION DISABLE CONSTRAINT OBSERVATION_FK1;
ALTER TABLE OMOPV2.OBSERVATION DISABLE CONSTRAINT OBSERVATION_FK2;
ALTER TABLE OMOPV2.OBSERVATION_PERIOD DISABLE CONSTRAINT OBSERVATION_PERIOD_FK1;
ALTER TABLE OMOPV2.PROCEDURE_OCCURRENCE DISABLE CONSTRAINT PROCEDURE_OCCURRENCE_FK1;
ALTER TABLE OMOPV2.PROCEDURE_OCCURRENCE DISABLE CONSTRAINT PROCEDURE_OCCURRENCE_FK2;
ALTER TABLE OMOPV2.VISIT_OCCURRENCE DISABLE CONSTRAINT VISIT_OCCURRENCE_FK1;
*/
/* ENABLE FKs After ETL */
/*
ALTER TABLE OMOPV2.CONDITION_ERA ENABLE CONSTRAINT CONDITION_ERA_FK1;
ALTER TABLE OMOPV2.CONDITION_ERA ENABLE CONSTRAINT CONDITION_ERA_FK2;
ALTER TABLE OMOPV2.CONDITION_OCCURRENCE ENABLE CONSTRAINT CONDITION_OCCURRENCE_FK1;
ALTER TABLE OMOPV2.CONDITION_OCCURRENCE ENABLE CONSTRAINT CONDITION_OCCURRENCE_FK2;
ALTER TABLE OMOPV2.DRUG_ERA ENABLE CONSTRAINT DRUG_ERA_FK1;
ALTER TABLE OMOPV2.DRUG_ERA ENABLE CONSTRAINT DRUG_ERA_FK2;
ALTER TABLE OMOPV2.DRUG_EXPOSURE ENABLE CONSTRAINT DRUG_EXPOSURE_FK1;
ALTER TABLE OMOPV2.DRUG_EXPOSURE ENABLE CONSTRAINT DRUG_EXPOSURE_FK2;
ALTER TABLE OMOPV2.OBSERVATION ENABLE CONSTRAINT OBSERVATION_FK1;
ALTER TABLE OMOPV2.OBSERVATION ENABLE CONSTRAINT OBSERVATION_FK2;
ALTER TABLE OMOPV2.OBSERVATION_PERIOD ENABLE CONSTRAINT OBSERVATION_PERIOD_FK1;
ALTER TABLE OMOPV2.PROCEDURE_OCCURRENCE ENABLE CONSTRAINT PROCEDURE_OCCURRENCE_FK1;
ALTER TABLE OMOPV2.PROCEDURE_OCCURRENCE ENABLE CONSTRAINT PROCEDURE_OCCURRENCE_FK2;
ALTER TABLE OMOPV2.VISIT_OCCURRENCE ENABLE CONSTRAINT VISIT_OCCURRENCE_FK1;
*/

/* Oracle Drop all sequences and tables */
/* Run as DB User, Not Sys! */
/* Commented Out

SET SERVEROUTPUT ON;

BEGIN
  
  dbms_output.put_line('/* DROP FKs */');
  dbms_output.put_line('/*');
  --DROP Foreign Keys for OMOPV2 (Hard Coded)
  FOR i IN (select owner,table_name,constraint_name
              from all_constraints 
             where constraint_type='R' 
               and owner='OMOPV2'
             order by owner,table_name,constraint_name) LOOP
    dbms_output.put_line('ALTER TABLE ' || i.owner || '.' || i.table_name || ' DROP CONSTRAINT ' || i.constraint_name ||';');
    --Optionally Execute
    --EXECUTE IMMEDIATE 'ALTER TABLE ' || i.owner || '.' || i.table_name || ' DROP CONSTRAINT ' || i.constraint_name ;
  END LOOP;
  dbms_output.put_line('*/');

  dbms_output.put_line('/* DISABLE FKs Before ETL */');
  dbms_output.put_line('/*');
  --DISABLE Foreign Keys for OMOPV2 (Hard Coded)
  FOR i IN (select owner,table_name,constraint_name
              from all_constraints 
             where constraint_type='R' 
               and owner='OMOPV2'
             order by owner,table_name,constraint_name) LOOP
    dbms_output.put_line('ALTER TABLE ' || i.owner || '.' || i.table_name || ' DISABLE CONSTRAINT ' || i.constraint_name ||';');
    --Optionally Execute
    --EXECUTE IMMEDIATE 'ALTER TABLE ' || i.owner || '.' || i.table_name || ' DISABLE CONSTRAINT ' || i.constraint_name ;
  END LOOP;
  dbms_output.put_line('*/');

  dbms_output.put_line('/* ENABLE FKs After ETL */');
  dbms_output.put_line('/*');
  --Enable Foreign Keys for OMOPV2 (Hard Coded)
  FOR i IN (select owner,table_name,constraint_name
              from all_constraints 
             where constraint_type='R' 
               and owner='OMOPV2'
             order by owner,table_name,constraint_name) LOOP
    dbms_output.put_line('ALTER TABLE ' || i.owner || '.' || i.table_name || ' ENABLE CONSTRAINT ' || i.constraint_name ||';');
    --Optionally Execute
    --EXECUTE IMMEDIATE 'ALTER TABLE ' || i.owner || '.' || i.table_name || ' ENABLE CONSTRAINT ' || i.constraint_name ;
  END LOOP;
  dbms_output.put_line('*/');

END;
/

*/

/* END OF FILE */
